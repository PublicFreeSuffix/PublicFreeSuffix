name: PR Status Management

on:
  pull_request:
    types: [closed]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  handle-pr-status:
    runs-on: ubuntu-latest
    name: Handle PR Status Changes
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Handle PR closure
      uses: actions/github-script@v7
      with:
        script: |
          const { data: pullRequest } = await github.rest.pulls.get({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: context.issue.number
          });
          
          const isMerged = pullRequest.merged;
          const prTitle = pullRequest.title;
          const prAuthor = pullRequest.user.login;
          
          console.log(`PR #${context.issue.number} was ${isMerged ? 'merged' : 'closed'}`);
          console.log(`Title: ${prTitle}`);
          console.log(`Author: ${prAuthor}`);
          
          let commentBody = '';
          
          if (isMerged) {
            commentBody = [
              '## ✅ PR Merged',
              '',
              '**Thank you for your contribution!**',
              '',
              'Your PR has been successfully merged into the main branch.',
              '',
              '**Processing Information:**',
              `- **Status:** Merged ✅`,
              `- **Title:** ${prTitle}`,
              `- **Author:** @${prAuthor}`,
              `- **Merge Time:** ${new Date().toISOString()}`,
              '',
              'Domain registration information is now active. Thank you for using our service!'
            ].join('\n');
          } else {
            commentBody = [
              '## ❌ PR Closed',
              '',
              'PR has been closed but not merged.',
              '',
              '**Processing Information:**',
              `- **Status:** Closed ❌`,
              `- **Title:** ${prTitle}`,
              `- **Author:** @${prAuthor}`,
              `- **Close Time:** ${new Date().toISOString()}`,
              '',
              'If you believe this is an error, please reopen the PR or create a new PR.'
            ].join('\n');
          }
          
          await github.rest.issues.createComment({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
            body: commentBody
          });
          
          if (isMerged) {
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: pullRequest.head.sha,
              state: 'success',
              target_url: `https://github.com/${context.repo.owner}/${context.repo.repo}/pull/${context.issue.number}`,
              description: 'PR successfully merged',
              context: 'PR Status'
            });
          }

    - name: Log PR statistics
      uses: actions/github-script@v7
      with:
        script: |
          const { data: pullRequest } = await github.rest.pulls.get({
            owner: context.repo.owner,
            repo: context.repo.repo,
            pull_number: context.issue.number
          });
          
          console.log('PR Statistics:');
          console.log(`- Number: #${context.issue.number}`);
          console.log(`- Title: ${pullRequest.title}`);
          console.log(`- Author: ${pullRequest.user.login}`);
          console.log(`- Status: ${pullRequest.merged ? 'Merged' : 'Closed'}`);
          console.log(`- Created: ${pullRequest.created_at}`);
          console.log(`- Closed: ${pullRequest.closed_at}`);
          console.log(`- Files changed: ${pullRequest.changed_files}`);
          console.log(`- Additions: ${pullRequest.additions}`);
          console.log(`- Deletions: ${pullRequest.deletions}`);
          
          if (pullRequest.merged) {
            console.log(`- Merged by: ${pullRequest.merged_by?.login || 'Unknown'}`);
            console.log(`- Merged at: ${pullRequest.merged_at}`);
          } 